<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Bulk Crop Pro | חיתוך קבוצתי חכם</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/react-image-crop/dist/ReactCrop.css" />
  <style>
    :root { --primary: #4f46e5; --primary-hover: #4338ca; }
    body { 
      font-family: 'Assistant', sans-serif; 
      background-color: #f8fafc; 
      color: #0f172a; 
      margin: 0; 
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      touch-action: pan-y;
      user-select: none;
    }
    
    .animate-in { animation: fadeIn 0.15s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* ReactCrop Customization */
    .ReactCrop { 
      z-index: 100 !important; 
      max-width: 100%;
      max-height: 100%;
    }
    .ReactCrop__crop-selection { 
      z-index: 110 !important;
      border: 1px solid rgba(255,255,255,1) !important;
      outline: 1px solid var(--primary) !important;
      box-shadow: 0 0 0 9999em rgba(0, 0, 0, 0.75) !important;
    }
    .ReactCrop__drag-handle { 
      z-index: 120 !important;
      background-color: var(--primary) !important;
      width: 14px !important;
      height: 14px !important;
      border-radius: 4px;
      border: 2px solid white !important;
    }

    .editor-stage {
      flex: 1;
      position: relative;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      padding: 20px;
    }

    .image-workspace {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .crop-target {
      display: block;
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

    .selectable-card {
      transition: all 0.2s ease;
    }
    .selectable-card.selected {
      outline: 4px solid var(--primary);
      outline-offset: -4px;
      transform: scale(0.92);
    }

    .sidebar-label {
      font-size: 0.65rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #64748b;
    }
    
    .aspect-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 4px;
      border-radius: 8px;
      border: 1px solid #1e293b;
      background: #0f172a;
      color: #94a3b8;
      font-size: 10px;
      font-weight: bold;
      transition: all 0.2s;
    }
    .aspect-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    .aspect-box {
      border: 1.5px solid currentColor;
      border-radius: 2px;
    }
  </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19",
    "react-dom": "https://esm.sh/react-dom@19",
    "react-dom/client": "https://esm.sh/react-dom@19/client",
    "lucide-react": "https://esm.sh/lucide-react@0.460.0",
    "react-image-crop": "https://esm.sh/react-image-crop@11.0.7",
    "jspdf": "https://esm.sh/jspdf@2.5.1"
  }
}
</script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-type="module" data-presets="react,typescript">
    import React, { useState, useEffect, useRef, useCallback } from 'react';
    import { createRoot } from 'react-dom/client';
    import { 
      Upload, Scissors, Crop, Download, Trash2, X, Check, 
      Plus, ChevronLeft, ChevronRight, Layers, Settings2, Minus,
      MousePointer2, Copy, Trash, Image as ImageIcon
    } from 'lucide-react';
    import ReactCrop, { centerCrop, makeAspectCrop } from 'react-image-crop';
    import { jsPDF } from 'jspdf';

    const App = () => {
      // Main Gallery State
      const [images, setImages] = useState([]);
      const [editingIndex, setEditingIndex] = useState(null);
      const [selectedIds, setSelectedIds] = useState(new Set());
      const [isDraggingSelection, setIsDraggingSelection] = useState(false);
      
      // Editor Settings
      const [crop, setCrop] = useState();
      const [pixelCrop, setPixelCrop] = useState();
      const [aspect, setAspect] = useState(undefined);
      const [zoom, setZoom] = useState(1);
      const [expandCanvas, setExpandCanvas] = useState(false);
      const [bgType, setBgType] = useState('blur');
      const [bgColor, setBgColor] = useState('#ffffff');
      
      const imgRef = useRef(null);
      const touchDistRef = useRef(0);

      // --- File Upload ---
      const handleFiles = useCallback((files) => {
        const newFiles = Array.from(files).filter(f => f.type.startsWith('image/')).map(f => ({
          id: Math.random().toString(36).substr(2, 9),
          url: URL.createObjectURL(f),
          name: f.name,
          cropped: null,
          lastCrop: null // Store specific crop settings per image
        }));
        setImages(prev => [...prev, ...newFiles]);
      }, []);

      useEffect(() => {
        const handlePaste = (e) => {
          const files = Array.from(e.clipboardData?.items || [])
            .filter(item => item.type.indexOf('image') !== -1)
            .map(item => item.getAsFile());
          if (files.length > 0) handleFiles(files);
        };
        window.addEventListener('paste', handlePaste);
        return () => window.removeEventListener('paste', handlePaste);
      }, [handleFiles]);

      // --- Selection Logic ---
      const toggleSelect = (id) => {
        setSelectedIds(prev => {
          const next = new Set(prev);
          if (next.has(id)) next.delete(id);
          else next.add(id);
          return next;
        });
      };

      const handleBatchDelete = () => {
        setImages(prev => prev.filter(img => !selectedIds.has(img.id)));
        setSelectedIds(new Set());
      };

      // --- Editor Logic ---
      const initCrop = (img, targetAspect) => {
        if (!img) return;
        const { width, height } = img;
        const effectiveAspect = targetAspect !== undefined ? targetAspect : (width / height);
        
        // Default to full width (100%) as requested
        const initialCrop = centerCrop(
          makeAspectCrop({ unit: '%', width: 100 }, effectiveAspect, width, height),
          width, height
        );
        setCrop(initialCrop);
      };

      const onImageLoad = (e) => {
        imgRef.current = e.currentTarget;
        // Use last known crop for this specific image if exists
        const currentImg = images[editingIndex];
        if (currentImg?.lastCrop) {
          setCrop(currentImg.lastCrop);
        } else {
          initCrop(e.currentTarget, aspect);
        }
        setZoom(1);
      };

      const changeAspect = (newAspect) => {
        setAspect(newAspect);
        if (imgRef.current) initCrop(imgRef.current, newAspect);
      };

      // --- Bulk Apply ---
      const applyToAll = () => {
        if (!crop) return;
        // Apply current crop settings and aspect to all images
        setImages(prev => prev.map(img => ({
          ...img,
          lastCrop: { ...crop },
          // We don't generate the blob yet to save memory, 
          // blobs will be generated on download or if they manually edit
        })));
        alert('הגדרות החיתוך הוחלו על כל התמונות ברשימה!');
      };

      // --- Pinch Zoom ---
      const handleTouchStart = (e) => {
        if (e.touches.length === 2) {
          touchDistRef.current = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
          );
        }
      };

      const handleTouchMove = (e) => {
        if (e.touches.length === 2 && touchDistRef.current > 0) {
          const dist = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
          );
          const ratio = dist / touchDistRef.current;
          setZoom(z => Math.min(Math.max(z * ratio, 0.5), 5));
          touchDistRef.current = dist;
        }
      };

      // --- Generation ---
      const processImage = async (imgData, specificPixelCrop, isBulk = false) => {
        const image = new Image();
        image.src = imgData.url;
        await new Promise(r => image.onload = r);

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // If it's a bulk process and we only have percentage crop
        let finalPixelCrop = specificPixelCrop;
        if (!finalPixelCrop && imgData.lastCrop) {
          const c = imgData.lastCrop;
          finalPixelCrop = {
            x: (c.x * image.width) / 100,
            y: (c.y * image.height) / 100,
            width: (c.width * image.width) / 100,
            height: (c.height * image.height) / 100
          };
        }

        if (!finalPixelCrop) return imgData.url;

        canvas.width = finalPixelCrop.width;
        canvas.height = finalPixelCrop.height;

        ctx.drawImage(
          image,
          finalPixelCrop.x, finalPixelCrop.y, finalPixelCrop.width, finalPixelCrop.height,
          0, 0, finalPixelCrop.width, finalPixelCrop.height
        );
        
        return new Promise(resolve => {
          canvas.toBlob(blob => resolve(URL.createObjectURL(blob)), 'image/jpeg', 0.9);
        });
      };

      const handleSaveCurrent = async () => {
        // Update current image with its specific crop
        const croppedUrl = await processImage(images[editingIndex], pixelCrop);
        setImages(prev => prev.map((img, i) => i === editingIndex ? { ...img, cropped: croppedUrl, lastCrop: crop } : img));
        
        if (editingIndex < images.length - 1) setEditingIndex(editingIndex + 1);
        else setEditingIndex(null);
      };

      const downloadAll = async () => {
        for (let i = 0; i < images.length; i++) {
          const img = images[i];
          const finalUrl = img.cropped || await processImage(img, null);
          const l = document.createElement('a');
          l.href = finalUrl;
          l.download = `crop-${i+1}-${img.name}`;
          l.click();
          await new Promise(r => setTimeout(r, 300));
        }
      };

      return (
        <div className="h-full flex flex-col bg-slate-50" 
             onDragOver={e => e.preventDefault()} 
             onDrop={e => { e.preventDefault(); handleFiles(e.dataTransfer.files); }}>
          
          {/* Header */}
          <header className="h-16 bg-white border-b px-6 flex items-center justify-between z-40 shadow-sm shrink-0">
            <div className="flex items-center gap-3">
              <div className="bg-indigo-600 p-2 rounded-xl text-white shadow-lg shadow-indigo-200"><Scissors size={20}/></div>
              <h1 className="text-lg font-black text-slate-900 tracking-tight">Bulk Crop</h1>
            </div>
            <div className="flex gap-2">
              {images.length > 0 && selectedIds.size > 0 && (
                <button onClick={handleBatchDelete} className="bg-red-50 text-red-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-red-100 transition-all flex items-center gap-2">
                  <Trash size={14}/> מחק ({selectedIds.size})
                </button>
              )}
              {images.length > 0 && (
                <button onClick={() => setEditingIndex(0)} className="bg-indigo-600 text-white px-5 py-2 rounded-xl text-xs font-bold shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition-all">
                  ערוך תמונות
                </button>
              )}
            </div>
          </header>

          {/* Main Gallery */}
          <main className="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar">
            {images.length === 0 ? (
              <div 
                onClick={() => { const i = document.createElement('input'); i.type='file'; i.multiple=true; i.accept="image/*"; i.onchange=e=>handleFiles(e.target.files); i.click(); }}
                className="h-full border-4 border-dashed border-slate-200 bg-white rounded-[2.5rem] flex flex-col items-center justify-center cursor-pointer hover:border-indigo-300 hover:bg-indigo-50/30 transition-all group"
              >
                <div className="w-20 h-20 bg-slate-50 rounded-3xl flex items-center justify-center mb-6 group-hover:scale-110 group-hover:bg-indigo-100 transition-all">
                  <Upload size={40} className="text-slate-300 group-hover:text-indigo-600"/>
                </div>
                <p className="text-xl font-extrabold text-slate-800">העלה תמונות להתחלה</p>
                <p className="text-slate-400 font-medium mt-2">גרור לכאן קבצים או בחר מהגלריה</p>
              </div>
            ) : (
              <div className="max-w-7xl mx-auto space-y-8 animate-in">
                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                  <div>
                    <h2 className="text-xl font-extrabold text-slate-900">הגלריה שלי</h2>
                    <p className="text-slate-400 text-xs font-bold mt-1 uppercase tracking-widest">{images.length} תמונות הועלו</p>
                  </div>
                  <div className="flex items-center gap-3">
                    <button onClick={() => { const i = document.createElement('input'); i.type='file'; i.multiple=true; i.accept="image/*"; i.onchange=e=>handleFiles(e.target.files); i.click(); }}
                            className="p-3 bg-slate-50 text-slate-600 rounded-2xl hover:bg-slate-100 transition-all"><Plus size={20}/></button>
                    <button onClick={downloadAll} className="px-8 py-3 bg-slate-900 text-white rounded-2xl font-bold text-sm hover:bg-black shadow-xl shadow-slate-200 flex items-center gap-2">
                      <Download size={18}/> הורד הכל
                    </button>
                  </div>
                </div>

                {/* Grid with drag selection */}
                <div 
                  className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4"
                  onMouseLeave={() => setIsDraggingSelection(false)}
                  onMouseUp={() => setIsDraggingSelection(false)}
                >
                  {images.map((img, idx) => (
                    <div 
                      key={img.id} 
                      onMouseDown={(e) => { setIsDraggingSelection(true); toggleSelect(img.id); }}
                      onMouseEnter={() => { if(isDraggingSelection) toggleSelect(img.id); }}
                      className={`selectable-card group relative bg-white p-2 rounded-2xl border border-slate-100 shadow-sm cursor-pointer ${selectedIds.has(img.id) ? 'selected' : 'hover:border-indigo-200'}`}
                    >
                      <div className="aspect-square relative rounded-xl overflow-hidden bg-slate-100">
                        <img src={img.cropped || img.url} className="w-full h-full object-cover" />
                        
                        {/* Checkbox Overlay */}
                        <div className={`absolute top-2 right-2 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${selectedIds.has(img.id) ? 'bg-indigo-600 border-indigo-600 text-white scale-110' : 'bg-white/40 border-white opacity-0 group-hover:opacity-100'}`}>
                          {selectedIds.has(img.id) && <Check size={14} strokeWidth={4}/>}
                        </div>

                        {/* Status Label */}
                        {img.cropped && !selectedIds.has(img.id) && (
                          <div className="absolute inset-0 bg-black/20 flex items-center justify-center">
                            <span className="bg-white/90 text-slate-900 px-3 py-1 rounded-full text-[10px] font-black uppercase">עובד</span>
                          </div>
                        )}

                        {/* Individual Delete */}
                        <button 
                          onClick={(e) => { e.stopPropagation(); setImages(prev => prev.filter(i => i.id !== img.id)); }}
                          className="absolute bottom-2 left-2 p-2 bg-red-500 text-white rounded-xl opacity-0 group-hover:opacity-100 hover:bg-red-600 transition-all shadow-lg"
                        >
                          <X size={14}/>
                        </button>
                      </div>
                      <div className="mt-2 px-1 flex items-center justify-between">
                        <p className="text-[10px] font-bold text-slate-500 truncate uppercase">{img.name}</p>
                        <button onClick={(e) => { e.stopPropagation(); setEditingIndex(idx); }} className="text-indigo-600 p-1 hover:bg-indigo-50 rounded-lg transition-all">
                          <ImageIcon size={14}/>
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </main>

          {/* Full Screen Editor */}
          {editingIndex !== null && (
            <div className="fixed inset-0 z-[100] bg-slate-950 flex flex-col animate-in">
              <header className="h-12 px-6 flex justify-between items-center bg-slate-900/50 backdrop-blur-md border-b border-white/5 shrink-0">
                <div className="flex items-center gap-4">
                  <div className="bg-white/10 text-white px-3 py-1 rounded-full text-[10px] font-black tracking-widest">{editingIndex + 1} / {images.length}</div>
                  <h3 className="text-xs font-bold text-slate-400 truncate max-w-[200px]">{images[editingIndex].name}</h3>
                </div>
                <div className="flex items-center gap-3">
                  <button onClick={applyToAll} className="hidden md:flex items-center gap-2 px-4 py-1.5 bg-indigo-600 text-white rounded-xl text-[10px] font-black hover:bg-indigo-700 transition-all shadow-lg">
                    <Copy size={12}/> החל על כולם
                  </button>
                  <button onClick={() => setEditingIndex(null)} className="p-2 text-slate-500 hover:text-white transition-all"><X size={20}/></button>
                </div>
              </header>

              <div className="flex-1 flex overflow-hidden">
                {/* Editor Sidebar */}
                <aside className="w-16 md:w-56 bg-slate-900 border-l border-white/5 p-4 space-y-8 overflow-y-auto no-scrollbar shrink-0 order-2 md:order-1">
                  <div>
                    <label className="sidebar-label block mb-4 flex items-center gap-2"><Settings2 size={12}/> יחס חיתוך</label>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                      {[
                        {l: '1:1', v: 1, w: 16, h: 16}, 
                        {l: '16:9', v: 16/9, w: 20, h: 12}, 
                        {l: '9:16', v: 9/16, w: 12, h: 20}, 
                        {l: 'מקורי', v: undefined, w: 18, h: 14}
                      ].map(a => (
                        <button key={a.l} onClick={() => changeAspect(a.v)} className={`aspect-btn ${aspect === a.v ? 'active' : ''}`}>
                          <div className="aspect-box" style={{ width: a.w, height: a.h }}></div>
                          {a.l}
                        </button>
                      ))}
                    </div>
                  </div>

                  <div className="pt-6 border-t border-white/5">
                    <label className="sidebar-label block mb-4 flex items-center gap-2"><Layers size={12}/> אפשרויות קנבס</label>
                    <div className="flex items-center justify-between p-3 bg-white/5 rounded-2xl">
                      <span className="text-[10px] font-bold text-slate-400">הרחב תמונה</span>
                      <input type="checkbox" checked={expandCanvas} onChange={e => setExpandCanvas(e.target.checked)} className="w-4 h-4 rounded accent-indigo-500 cursor-pointer"/>
                    </div>
                    {expandCanvas && (
                      <div className="mt-3 space-y-2 animate-in">
                        {['blur', 'color'].map(t => (
                          <button key={t} onClick={() => setBgType(t)} className={`w-full py-2 px-3 rounded-xl text-[10px] font-bold text-right transition-all ${bgType === t ? 'bg-white/10 text-white' : 'text-slate-500 hover:text-slate-300'}`}>
                            {t === 'blur' ? 'טשטוש רקע' : 'צבע אחיד'}
                          </button>
                        ))}
                      </div>
                    )}
                  </div>
                </aside>

                {/* Viewport */}
                <section className="editor-stage order-1 md:order-2" onTouchStart={handleTouchStart} onTouchMove={handleTouchMove}>
                  <div className="image-workspace" style={{ transform: `scale(${zoom})` }}>
                    <ReactCrop 
                      crop={crop} 
                      onChange={c => setCrop(c)} 
                      onComplete={c => setPixelCrop(c)} 
                      aspect={aspect}
                    >
                      <div className={`relative flex items-center justify-center transition-all ${expandCanvas ? 'p-12 md:p-24' : ''}`}
                           style={{ background: expandCanvas && bgType === 'color' ? bgColor : 'transparent' }}>
                        {expandCanvas && bgType === 'blur' && (
                          <img src={images[editingIndex].url} className="absolute inset-0 w-[150%] h-[150%] -left-[25%] -top-[25%] object-cover blur-3xl opacity-40"/>
                        )}
                        <img ref={imgRef} src={images[editingIndex].url} onLoad={onImageLoad} className="crop-target relative z-10 shadow-2xl"/>
                      </div>
                    </ReactCrop>
                  </div>
                </section>
              </div>

              {/* Editor Footer */}
              <footer className="h-20 bg-slate-900 border-t border-white/5 px-8 flex items-center justify-between shrink-0 z-20">
                <button 
                  onClick={() => setEditingIndex(i => Math.max(0, i-1))} 
                  disabled={editingIndex === 0}
                  className="p-4 bg-white/5 text-white rounded-2xl disabled:opacity-5 transition-all hover:bg-white/10"
                >
                  <ChevronRight size={20}/>
                </button>
                
                <div className="flex items-center gap-4 bg-white/5 p-2 rounded-2xl">
                   <button onClick={() => setZoom(z => Math.max(0.5, z - 0.2))} className="p-2 text-slate-400 hover:text-white transition-all"><Minus size={16}/></button>
                   <span className="text-[11px] font-black text-white w-12 text-center">{Math.round(zoom * 100)}%</span>
                   <button onClick={() => setZoom(z => Math.min(5, z + 0.2))} className="p-2 text-slate-400 hover:text-white transition-all"><Plus size={16}/></button>
                </div>

                <button onClick={handleSaveCurrent} className="px-12 py-4 bg-indigo-600 text-white rounded-2xl font-black text-sm shadow-2xl shadow-indigo-900/40 hover:bg-indigo-700 transition-all flex items-center gap-2">
                  {editingIndex === images.length - 1 ? 'סיום ושמירה' : 'התמונה הבאה'} <ChevronLeft size={18}/>
                </button>
              </footer>
            </div>
          )}
        </div>
      );
    };

    createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>