<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Bulk Crop Pro | חיתוך קבוצתי חכם</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/react-image-crop/dist/ReactCrop.css" />
  <style>
    :root { --primary: #6366f1; --primary-hover: #4f46e5; }
    
    body { 
      font-family: 'Assistant', sans-serif; 
      background-color: #f1f5f9; 
      color: #1e293b; 
      margin: 0; 
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }

    body.editor-active {
      overflow: hidden;
      height: 100vh;
    }

    /* Modern Scrollbars */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

    /* ReactCrop Logic Fix for RTL */
    .ReactCrop { 
      direction: ltr !important; 
      touch-action: none;
    }
    .ReactCrop__crop-selection { 
      border: 1px solid white !important;
      outline: 1px solid var(--primary) !important;
      box-shadow: 0 0 0 9999em rgba(0, 0, 0, 0.75) !important;
    }
    .ReactCrop__drag-handle { 
      background-color: var(--primary) !important;
      width: 22px !important;
      height: 22px !important;
      border-radius: 50%;
      border: 3px solid white !important;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }

    /* Editor Layout Components */
    .editor-overlay {
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: #0f172a;
      display: flex;
      flex-direction: column;
      animation: editorSlideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes editorSlideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .editor-canvas {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background-image: radial-gradient(#334155 1px, transparent 1px);
      background-size: 32px 32px;
      direction: ltr !important;
    }

    .tool-panel {
      background: #1e293b;
      border-top: 1px solid #334155;
      padding: 1rem;
      z-index: 20;
    }

    .aspect-chip {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px;
      border-radius: 12px;
      background: #0f172a;
      border: 1px solid #334155;
      color: #94a3b8;
      font-size: 11px;
      font-weight: 700;
      min-width: 64px;
      transition: all 0.2s;
    }

    .aspect-chip.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .aspect-box {
      border: 1.5px solid currentColor;
      border-radius: 2px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      font-weight: 800;
      border-radius: 14px;
      padding: 0 24px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
      box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.4);
    }
    .btn-primary:active { transform: scale(0.96); }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.05);
      color: #f8fafc;
      font-weight: 700;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 14px;
      height: 52px;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .btn-secondary:active { background: rgba(255, 255, 255, 0.1); }

    .zoom-control {
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 100px;
      padding: 4px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: absolute;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 30;
    }

    .selectable-card.selected {
      outline: 4px solid var(--primary);
      outline-offset: -4px;
    }
  </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19",
    "react-dom": "https://esm.sh/react-dom@19",
    "react-dom/client": "https://esm.sh/react-dom@19/client",
    "lucide-react": "https://esm.sh/lucide-react@0.460.0",
    "react-image-crop": "https://esm.sh/react-image-crop@11.0.7"
  }
}
</script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-type="module" data-presets="react,typescript">
    import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
    import { createRoot } from 'react-dom/client';
    import { 
      Upload, Scissors, Download, X, Check, 
      Plus, ChevronLeft, ChevronRight, Copy, ImageIcon, RefreshCw, Minus, Loader2, Maximize
    } from 'lucide-react';
    import ReactCrop, { centerCrop, makeAspectCrop } from 'react-image-crop';

    const VERSION = "v1.3.0";

    const App = () => {
      const [images, setImages] = useState([]);
      const [editingIndex, setEditingIndex] = useState(null);
      const [selectedIds, setSelectedIds] = useState(new Set());
      const [isProcessing, setIsProcessing] = useState(false);
      
      const [crop, setCrop] = useState();
      const [aspect, setAspect] = useState(undefined);
      const [zoom, setZoom] = useState(1);
      
      const imgRef = useRef(null);

      useEffect(() => {
        if (editingIndex !== null) document.body.classList.add('editor-active');
        else document.body.classList.remove('editor-active');
      }, [editingIndex]);

      const handleFiles = useCallback((files) => {
        const newFiles = Array.from(files).filter(f => f.type.startsWith('image/')).map(f => ({
          id: Math.random().toString(36).substr(2, 9),
          url: URL.createObjectURL(f),
          name: f.name,
          cropped: null,
          lastCrop: null,
          lastAspect: undefined
        }));
        setImages(prev => [...prev, ...newFiles]);
      }, []);

      const toggleSelect = (id) => {
        setSelectedIds(prev => {
          const next = new Set(prev);
          if (next.has(id)) next.delete(id);
          else next.add(id);
          return next;
        });
      };

      const handleBatchDelete = () => {
        setImages(prev => prev.filter(img => !selectedIds.has(img.id)));
        setSelectedIds(new Set());
      };

      const getInitialCrop = (img, targetAspect) => {
        if (!img) return;
        const nw = img.naturalWidth || img.width;
        const nh = img.naturalHeight || img.height;
        const effAspect = targetAspect !== undefined ? targetAspect : (nw / nh);
        return centerCrop(makeAspectCrop({ unit: '%', width: 90 }, effAspect, nw, nh), nw, nh);
      };

      const onImageLoad = (e) => {
        imgRef.current = e.currentTarget;
        const currentImg = images[editingIndex];
        if (currentImg?.lastCrop) {
          setCrop(currentImg.lastCrop);
          setAspect(currentImg.lastAspect);
        } else {
          setCrop(getInitialCrop(e.currentTarget, aspect));
        }
      };

      const applyToAll = () => {
        if (!crop) return;
        setImages(prev => prev.map(img => ({
          ...img,
          lastCrop: { ...crop },
          lastAspect: aspect,
          cropped: null 
        })));
        alert('הגדרות החיתוך הוחלו על כל התמונות');
      };

      const processAndSave = async () => {
        if (!crop || !imgRef.current) return;
        setIsProcessing(true);
        
        try {
          const image = imgRef.current;
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          const nw = image.naturalWidth;
          const nh = image.naturalHeight;
          const pixelX = (crop.x * nw) / 100;
          const pixelY = (crop.y * nh) / 100;
          const pixelW = (crop.width * nw) / 100;
          const pixelH = (crop.height * nh) / 100;

          canvas.width = pixelW;
          canvas.height = pixelH;
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = 'high';
          ctx.drawImage(image, pixelX, pixelY, pixelW, pixelH, 0, 0, pixelW, pixelH);
          
          const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.95));
          const croppedUrl = URL.createObjectURL(blob);

          setImages(prev => prev.map((img, i) => 
            i === editingIndex ? { ...img, cropped: croppedUrl, lastCrop: crop, lastAspect: aspect } : img
          ));

          if (editingIndex < images.length - 1) {
            setEditingIndex(editingIndex + 1);
          } else {
            setEditingIndex(null);
          }
        } catch (err) {
          console.error(err);
        } finally {
          setIsProcessing(false);
        }
      };

      const downloadBatch = async () => {
        for (let i = 0; i < images.length; i++) {
          const img = images[i];
          if (!img.cropped) continue;
          const link = document.createElement('a');
          link.href = img.cropped;
          link.download = `bulk-crop-${i + 1}.jpg`;
          link.click();
          await new Promise(r => setTimeout(r, 400));
        }
      };

      return (
        <div className="min-h-screen flex flex-col bg-[#f8fafc]">
          
          {/* Main App Header */}
          <header className="h-20 bg-white border-b border-slate-200 px-6 md:px-12 flex items-center justify-between sticky top-0 z-50 shadow-sm">
            <div className="flex items-center gap-4">
              <div className="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                <Scissors size={24} />
              </div>
              <div>
                <h1 className="text-xl font-black text-slate-900 leading-tight">Bulk Crop Pro</h1>
                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{VERSION}</p>
              </div>
            </div>
            
            <div className="flex items-center gap-3">
              {images.length > 0 && selectedIds.size > 0 && (
                <button onClick={handleBatchDelete} className="px-4 py-2 bg-red-50 text-red-600 rounded-xl text-xs font-black hover:bg-red-100">
                  מחק ({selectedIds.size})
                </button>
              )}
              {images.length > 0 && (
                <button onClick={() => setEditingIndex(0)} className="btn-primary h-11 px-6 shadow-md">
                  עריכה קבוצתית
                </button>
              )}
            </div>
          </header>

          <main className="flex-1 max-w-7xl mx-auto w-full p-6 md:p-12">
            {images.length === 0 ? (
              <div 
                onClick={() => { const i = document.createElement('input'); i.type='file'; i.multiple=true; i.accept="image/*"; i.onchange=e=>handleFiles(e.target.files); i.click(); }}
                className="min-h-[60vh] border-4 border-dashed border-slate-200 bg-white rounded-[3rem] flex flex-col items-center justify-center cursor-pointer hover:border-indigo-300 hover:bg-indigo-50/20 transition-all group"
              >
                <div className="p-8 bg-slate-50 rounded-full mb-6 group-hover:scale-110 group-hover:bg-indigo-50 transition-all shadow-inner">
                  <Upload size={56} className="text-slate-300 group-hover:text-indigo-600"/>
                </div>
                <h2 className="text-2xl font-black text-slate-800">בחר תמונות לעבודה</h2>
                <p className="text-slate-400 font-bold mt-2">גרור לכאן קבצים או לחץ לבחירה מהמחשב</p>
              </div>
            ) : (
              <div className="space-y-12 animate-in">
                <div className="flex flex-col md:flex-row md:items-center justify-between gap-6 bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm">
                  <div>
                    <h2 className="text-2xl font-black text-slate-900">הגלריה שלך</h2>
                    <p className="text-slate-400 font-bold mt-1 tracking-wide">{images.length} קבצים בטעינה</p>
                  </div>
                  <div className="flex items-center gap-4">
                    <button onClick={() => { const i = document.createElement('input'); i.type='file'; i.multiple=true; i.accept="image/*"; i.onchange=e=>handleFiles(e.target.files); i.click(); }}
                            className="w-14 h-14 bg-slate-50 text-slate-500 rounded-2xl flex items-center justify-center hover:bg-slate-100 border border-slate-100 transition-all active:scale-95">
                      <Plus size={24}/>
                    </button>
                    <button onClick={downloadBatch} className="btn-primary px-10 h-14 text-base">
                      <Download size={20}/> הורד את הכל
                    </button>
                  </div>
                </div>

                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                  {images.map((img, idx) => (
                    <div 
                      key={img.id} 
                      onClick={() => toggleSelect(img.id)}
                      className={`group relative bg-white p-3 rounded-[1.8rem] border border-slate-100 shadow-md cursor-pointer transition-all hover:shadow-xl ${selectedIds.has(img.id) ? 'ring-4 ring-indigo-500 ring-offset-2' : ''}`}
                    >
                      <div className="aspect-square relative rounded-[1.4rem] overflow-hidden bg-slate-100">
                        <img src={img.cropped || img.url} className="w-full h-full object-cover" />
                        <div className={`absolute top-3 right-3 w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${selectedIds.has(img.id) ? 'bg-indigo-600 border-indigo-600 text-white shadow-lg' : 'bg-white/40 border-white/60 opacity-0 group-hover:opacity-100'}`}>
                          {selectedIds.has(img.id) && <Check size={18} strokeWidth={4}/>}
                        </div>
                        {img.cropped && !selectedIds.has(img.id) && (
                          <div className="absolute inset-0 bg-emerald-500/10 flex items-center justify-center">
                            <span className="bg-emerald-500 text-white px-4 py-1.5 rounded-full text-[10px] font-black uppercase shadow-lg">מעובד</span>
                          </div>
                        )}
                      </div>
                      <div className="mt-3 px-1 flex items-center justify-between">
                        <p className="text-[10px] font-black text-slate-400 truncate uppercase w-3/4">{img.name}</p>
                        <button 
                          onClick={(e) => { e.stopPropagation(); setEditingIndex(idx); }} 
                          className="w-8 h-8 flex items-center justify-center text-indigo-600 bg-indigo-50 rounded-lg hover:bg-indigo-100 transition-colors"
                        >
                          <ImageIcon size={18}/>
                        </button>
                      </div>
                    </div>
                  ))}
                  <button onClick={() => { const i = document.createElement('input'); i.type='file'; i.multiple=true; i.accept="image/*"; i.onchange=e=>handleFiles(e.target.files); i.click(); }}
                          className="aspect-square border-4 border-dashed border-slate-200 bg-white rounded-[1.8rem] flex flex-col items-center justify-center gap-3 text-slate-300 hover:border-indigo-300 hover:text-indigo-600 transition-all active:scale-95 group">
                    <Plus size={40} className="group-hover:scale-110 transition-transform" />
                    <span className="text-xs font-black uppercase tracking-widest">הוסף עוד</span>
                  </button>
                </div>
              </div>
            )}
          </main>

          {/* New Modern Editor Overlay */}
          {editingIndex !== null && (
            <div className="editor-overlay">
              
              {/* Editor Header */}
              <header className="h-16 px-6 bg-slate-900 border-b border-white/5 flex items-center justify-between shrink-0">
                <div className="flex items-center gap-4">
                  <div className="bg-white/5 px-4 py-1.5 rounded-full text-white text-xs font-black tracking-widest">
                    תמונה {editingIndex + 1} מתוך {images.length}
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <button onClick={applyToAll} className="hidden md:flex items-center gap-2 px-5 py-2.5 bg-white/5 text-white rounded-xl text-[11px] font-black hover:bg-white/10 transition-all active:scale-95">
                    <Copy size={16}/> החל הגדרה על כולם
                  </button>
                  <button onClick={() => setEditingIndex(null)} className="w-10 h-10 flex items-center justify-center text-slate-500 hover:text-white transition-colors">
                    <X size={28}/>
                  </button>
                </div>
              </header>

              {/* Editor Main Content Area */}
              <div className="flex-1 flex flex-col md:flex-row overflow-hidden relative">
                
                {/* Canvas Section */}
                <section className="editor-canvas">
                  {isProcessing && (
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-md z-[100] flex items-center justify-center">
                      <div className="flex flex-col items-center gap-4">
                        <Loader2 size={48} className="text-indigo-500 animate-spin" />
                        <span className="text-white font-black text-sm uppercase tracking-widest">מעבד תמונה...</span>
                      </div>
                    </div>
                  )}

                  <div className="image-workspace" style={{ transform: `scale(${zoom})`, transition: 'transform 0.2s cubic-bezier(0.4, 0, 0.2, 1)' }}>
                    <ReactCrop 
                      crop={crop} 
                      onChange={c => setCrop(c)} 
                      aspect={aspect}
                      keepSelection
                      unit="%"
                    >
                      <img 
                        ref={imgRef} 
                        src={images[editingIndex].url} 
                        onLoad={onImageLoad} 
                        className="crop-target shadow-2xl rounded-sm"
                        draggable={false}
                      />
                    </ReactCrop>
                  </div>

                  {/* Zoom Floating Control */}
                  <div className="zoom-control">
                    <button onClick={() => setZoom(z => Math.max(0.5, z - 0.2))} className="w-10 h-10 rounded-full flex items-center justify-center text-slate-400 hover:text-white transition-colors">
                      <Minus size={20}/>
                    </button>
                    <span className="text-white text-[11px] font-black w-12 text-center">{Math.round(zoom * 100)}%</span>
                    <button onClick={() => setZoom(z => Math.min(3, z + 0.2))} className="w-10 h-10 rounded-full flex items-center justify-center text-slate-400 hover:text-white transition-colors">
                      <Plus size={20}/>
                    </button>
                    <div className="w-px h-6 bg-white/10 mx-1"></div>
                    <button onClick={() => setZoom(1)} className="w-10 h-10 rounded-full flex items-center justify-center text-slate-400 hover:text-white transition-colors">
                      <Maximize size={18}/>
                    </button>
                  </div>
                </section>

                {/* Desktop Aspect Sidebar / Mobile Aspect Panel */}
                <aside className="tool-panel md:w-80 md:border-t-0 md:border-r md:flex md:flex-col md:justify-between shrink-0">
                  <div className="space-y-6">
                    <div>
                      <h4 className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4">יחסי חיתוך</h4>
                      <div className="flex md:grid md:grid-cols-2 gap-3 overflow-x-auto no-scrollbar pb-2 md:pb-0">
                        {[
                          {l: '1:1', v: 1, w: 20, h: 20}, 
                          {l: '16:9', v: 16/9, w: 28, h: 16}, 
                          {l: '9:16', v: 9/16, w: 16, h: 28}, 
                          {l: 'חופשי', v: undefined, w: 24, h: 20}
                        ].map(a => (
                          <button key={a.l} onClick={() => setAspect(a.v)} className={`aspect-chip shrink-0 ${aspect === a.v ? 'active' : ''}`}>
                            <div className="aspect-box" style={{ width: a.w, height: a.h }}></div>
                            {a.l}
                          </button>
                        ))}
                      </div>
                    </div>

                    <div className="hidden md:block space-y-3">
                      <button onClick={() => setCrop(getInitialCrop(imgRef.current, aspect))} className="btn-secondary w-full text-xs">
                        <RefreshCw size={16} className="ml-2"/> איפוס מסגרת
                      </button>
                      <p className="text-[10px] text-slate-500 font-bold text-center uppercase tracking-wide px-4">
                        ניתן לשנות את המסגרת בגרירת הפינות או התמונה עצמה
                      </p>
                    </div>
                  </div>

                  {/* Navigation & Action Controls */}
                  <div className="mt-8 pt-6 border-t border-white/5 space-y-4">
                    <div className="flex gap-4">
                      <button 
                        onClick={() => setEditingIndex(idx => Math.max(0, idx - 1))} 
                        disabled={editingIndex === 0}
                        className="btn-secondary flex-1 disabled:opacity-20"
                      >
                        <ChevronRight size={24}/>
                      </button>
                      <button 
                        onClick={() => setEditingIndex(idx => Math.min(images.length - 1, idx + 1))} 
                        disabled={editingIndex === images.length - 1}
                        className="btn-secondary flex-1 disabled:opacity-20"
                      >
                        <ChevronLeft size={24}/>
                      </button>
                    </div>

                    <div className="flex flex-col gap-3">
                      <button 
                        onClick={() => setEditingIndex(null)}
                        className="btn-secondary h-12 text-sm text-red-400 hover:text-red-300 hover:bg-red-400/10 border-red-400/20"
                      >
                        ביטול שינויים
                      </button>
                      <button onClick={processAndSave} className="btn-primary h-14 text-base w-full">
                        {editingIndex === images.length - 1 ? 'אישור וסיים' : 'אישור והמשך'}
                        <Check size={20}/>
                      </button>
                    </div>
                  </div>
                </aside>
              </div>

            </div>
          )}
          
          <footer className="py-12 bg-white text-center border-t border-slate-100">
            <p className="text-[10px] font-black text-slate-300 uppercase tracking-[0.5em] mb-2">Bulk Crop Engine {VERSION}</p>
            <div className="flex items-center justify-center gap-4">
               <span className="w-1.5 h-1.5 rounded-full bg-indigo-500"></span>
               <span className="w-1.5 h-1.5 rounded-full bg-indigo-400"></span>
               <span className="w-1.5 h-1.5 rounded-full bg-indigo-300"></span>
            </div>
          </footer>

        </div>
      );
    };

    createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>