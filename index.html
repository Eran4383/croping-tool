<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Bulk Crop Pro | כלי חיתוך תמונות מתקדם</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/react-image-crop/dist/ReactCrop.css" />
  <style>
    :root { --primary: #6366f1; --bg-dark: #0f172a; }
    body { font-family: 'Assistant', sans-serif; background-color: #f8fafc; color: #1e293b; margin: 0; min-height: 100vh; }
    body.editor-active { overflow: hidden; height: 100vh; }
    .ReactCrop { direction: ltr !important; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border-radius: 4px; overflow: hidden; }
    .ReactCrop__crop-selection { border: 1px solid white !important; outline: 2px solid var(--primary) !important; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7) !important; }
    .ReactCrop__drag-handle { background-color: var(--primary) !important; width: 20px !important; height: 20px !important; border-radius: 50%; border: 2px solid white !important; }
    .editor-overlay { position: fixed; inset: 0; z-index: 2000; background: #0f172a; display: flex; flex-direction: column; animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .editor-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    @media (min-width: 768px) { .editor-body { flex-direction: row-reverse; } }
    .canvas-area { flex: 1; background-image: radial-gradient(#334155 1px, transparent 1px); background-size: 30px 30px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; padding: 2rem; }
    .sidebar { background: #1e293b; width: 100%; z-index: 50; display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.05); }
    @media (min-width: 768px) { .sidebar { width: 340px; } }
    .aspect-card { background: rgba(255,255,255,0.03); border: 2px solid transparent; border-radius: 16px; padding: 12px; cursor: pointer; transition: all 0.2s; color: #94a3b8; display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .aspect-card:hover { background: rgba(255,255,255,0.08); }
    .aspect-card.active { background: rgba(99, 102, 241, 0.15); border-color: var(--primary); color: white; }
    .aspect-box { border: 2px solid currentColor; border-radius: 3px; }
    .btn-main { height: 56px; border-radius: 16px; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; width: 100%; background: var(--primary); color: white; box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3); }
    .btn-main:active { transform: scale(0.96); }
    .zoom-ctrl { position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%); background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(10px); padding: 8px 16px; border-radius: 100px; display: flex; align-items: center; gap: 12px; border: 1px solid rgba(255,255,255,0.1); z-index: 100; }
  </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19",
    "react-dom": "https://esm.sh/react-dom@19",
    "react-dom/client": "https://esm.sh/react-dom@19/client",
    "lucide-react": "https://esm.sh/lucide-react@0.460.0",
    "react-image-crop": "https://esm.sh/react-image-crop@11.0.7"
  }
}
</script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-type="module" data-presets="react,typescript">
    import React, { useState, useEffect, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { 
      Upload, Scissors, Download, X, Check, 
      Plus, ChevronLeft, ChevronRight, Copy, ImageIcon, RefreshCw, ZoomIn, ZoomOut, Loader2, Trash2, Maximize
    } from 'lucide-react';
    import ReactCrop, { centerCrop, makeAspectCrop } from 'react-image-crop';

    const VERSION = "v1.6.5";

    const App = () => {
      const [images, setImages] = useState([]);
      const [editingIndex, setEditingIndex] = useState(null);
      const [isProcessing, setIsProcessing] = useState(false);
      const [crop, setCrop] = useState();
      const [aspect, setAspect] = useState(undefined);
      const [zoom, setZoom] = useState(1);
      const imgRef = useRef(null);

      useEffect(() => {
        if (editingIndex !== null) document.body.classList.add('editor-active');
        else document.body.classList.remove('editor-active');
      }, [editingIndex]);

      const handleFiles = (files) => {
        const newImages = Array.from(files).filter(f => f.type.startsWith('image/')).map(f => ({
          id: Math.random().toString(36).substr(2, 9),
          url: URL.createObjectURL(f),
          name: f.name,
          cropped: null,
          lastCrop: null,
          lastAspect: undefined
        }));
        setImages(prev => [...prev, ...newImages]);
      };

      const getInitialCrop = (img, targetAspect) => {
        const nw = img.naturalWidth;
        const nh = img.naturalHeight;
        const effAspect = targetAspect !== undefined ? targetAspect : (nw / nh);
        return centerCrop(makeAspectCrop({ unit: '%', width: 90 }, effAspect, nw, nh), nw, nh);
      };

      const onImageLoad = (e) => {
        imgRef.current = e.currentTarget;
        const currentImg = images[editingIndex];
        if (currentImg?.lastCrop) {
          setCrop(currentImg.lastCrop);
          setAspect(currentImg.lastAspect);
        } else {
          setCrop(getInitialCrop(e.currentTarget, aspect));
        }
      };

      const handleConfirm = async () => {
        if (!crop || !imgRef.current) return;
        setIsProcessing(true);
        
        try {
          const image = imgRef.current;
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          const nw = image.naturalWidth;
          const nh = image.naturalHeight;
          
          const px = (crop.x * nw) / 100;
          const py = (crop.y * nh) / 100;
          const pw = (crop.width * nw) / 100;
          const ph = (crop.height * nh) / 100;

          canvas.width = pw;
          canvas.height = ph;
          
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = 'high';
          ctx.drawImage(image, px, py, pw, ph, 0, 0, pw, ph);
          
          const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.95));
          const croppedUrl = URL.createObjectURL(blob);

          setImages(prev => prev.map((img, i) => 
            i === editingIndex ? { ...img, cropped: croppedUrl, lastCrop: crop, lastAspect: aspect } : img
          ));

          if (editingIndex < images.length - 1) {
            setEditingIndex(editingIndex + 1);
          } else {
            setEditingIndex(null);
          }
        } catch (err) {
          alert('שגיאה בשמירת התמונה.');
        } finally {
          setIsProcessing(false);
        }
      };

      const applyToAll = () => {
        if (!crop) return;
        setImages(prev => prev.map(img => ({ ...img, lastCrop: { ...crop }, lastAspect: aspect, cropped: null })));
        alert('הגדרות החיתוך הועתקו לכל התמונות.');
      };

      const downloadAll = async () => {
        for (const img of images) {
          if (!img.cropped) continue;
          const a = document.createElement('a');
          a.href = img.cropped;
          a.download = `crop-${img.name}`;
          a.click();
          await new Promise(r => setTimeout(r, 400));
        }
      };

      return (
        <div className="min-h-screen flex flex-col">
          <header className="h-20 bg-white border-b px-6 md:px-12 flex items-center justify-between sticky top-0 z-50">
            <div className="flex items-center gap-4">
              <div className="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-xl">
                <Scissors size={24} strokeWidth={2.5}/>
              </div>
              <div>
                <h1 className="text-xl font-black text-slate-900">Bulk Crop Pro</h1>
                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-none">{VERSION}</p>
              </div>
            </div>
            {images.length > 0 && (
              <button onClick={() => setEditingIndex(0)} className="bg-indigo-600 text-white h-11 px-6 rounded-xl font-black text-sm hover:bg-indigo-700 transition-all shadow-lg">התחל עריכה</button>
            )}
          </header>

          <main className="flex-1 p-6 md:p-12 max-w-7xl mx-auto w-full">
            {images.length === 0 ? (
              <div onClick={() => { const i = document.createElement('input'); i.type='file'; i.multiple=true; i.accept="image/*"; i.onchange=e=>handleFiles(e.target.files); i.click(); }}
                   className="min-h-[50vh] border-4 border-dashed border-slate-200 bg-white rounded-[3rem] flex flex-col items-center justify-center cursor-pointer hover:border-indigo-400 hover:bg-indigo-50/10 transition-all group">
                <Upload size={48} className="text-slate-300 group-hover:text-indigo-600 mb-4"/>
                <h2 className="text-2xl font-black text-slate-800">העלאת תמונות</h2>
                <p className="text-slate-400 font-bold mt-2">לחץ כאן או גרור קבצים</p>
              </div>
            ) : (
              <div className="space-y-10">
                <div className="flex flex-col md:flex-row md:items-center justify-between gap-6 bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm">
                  <div>
                    <h2 className="text-2xl font-black text-slate-900">הגלריה שלך</h2>
                    <p className="text-slate-400 font-bold mt-1 text-xs uppercase tracking-widest">{images.length} תמונות נבחרו</p>
                  </div>
                  <div className="flex gap-4">
                    <button onClick={() => { const i = document.createElement('input'); i.type='file'; i.multiple=true; i.accept="image/*"; i.onchange=e=>handleFiles(e.target.files); i.click(); }}
                            className="w-14 h-14 bg-slate-100 text-slate-500 rounded-2xl flex items-center justify-center hover:bg-slate-200 border border-slate-100"><Plus size={24}/></button>
                    <button onClick={downloadAll} className="bg-slate-900 text-white h-14 px-10 rounded-2xl font-black text-sm flex items-center gap-3 shadow-xl hover:bg-black transition-all">
                      <Download size={20}/> הורד הכל
                    </button>
                  </div>
                </div>

                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6">
                  {images.map((img, idx) => (
                    <div key={img.id} className="bg-white p-3 rounded-[1.8rem] border border-slate-100 shadow-md group">
                      <div className="aspect-square relative rounded-[1.4rem] overflow-hidden bg-slate-50">
                        <img src={img.cropped || img.url} className="w-full h-full object-cover" />
                        {img.cropped && <div className="absolute inset-0 bg-emerald-500/10 flex items-center justify-center backdrop-blur-[1px]"><span className="bg-emerald-500 text-white text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-widest">מעובד</span></div>}
                      </div>
                      <div className="mt-3 flex items-center justify-between px-1">
                        <p className="text-[10px] font-black text-slate-400 truncate w-2/3 uppercase">{img.name}</p>
                        <div className="flex gap-1">
                          <button onClick={() => setEditingIndex(idx)} className="text-indigo-600 w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center hover:bg-indigo-100"><ImageIcon size={16}/></button>
                          <button onClick={() => setImages(prev => prev.filter(i => i.id !== img.id))} className="text-red-500 w-8 h-8 rounded-lg bg-red-50 flex items-center justify-center hover:bg-red-100"><Trash2 size={16}/></button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </main>

          {editingIndex !== null && (
            <div className="editor-overlay">
              <header className="h-16 px-6 bg-slate-900 border-b border-white/5 flex items-center justify-between shrink-0">
                <div className="flex items-center gap-4">
                  <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white"><Scissors size={18}/></div>
                  <span className="text-slate-400 text-xs font-black tracking-widest">תמונה {editingIndex + 1} / {images.length}</span>
                </div>
                <div className="flex gap-4">
                  <button onClick={applyToAll} className="hidden md:flex items-center gap-2 text-white bg-white/5 px-4 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-white/10"><Copy size={14}/> החל על כולם</button>
                  <button onClick={() => setEditingIndex(null)} className="w-10 h-10 flex items-center justify-center text-slate-500 hover:text-white transition-colors"><X size={28}/></button>
                </div>
              </header>

              <div className="editor-body">
                <aside className="sidebar overflow-y-auto no-scrollbar">
                  <div className="p-6 space-y-8 flex-1">
                    <div>
                      <h3 className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4">יחס חיתוך</h3>
                      <div className="grid grid-cols-4 md:grid-cols-2 gap-3">
                        {[
                          {l: '1:1', v: 1, w: 20, h: 20}, {l: '16:9', v: 16/9, w: 28, h: 16}, 
                          {l: '9:16', v: 9/16, w: 16, h: 28}, {l: 'חופשי', v: undefined, w: 22, h: 20}
                        ].map(a => (
                          <div key={a.l} onClick={() => { setAspect(a.v); if(imgRef.current) setCrop(getInitialCrop(imgRef.current, a.v)); }} className={`aspect-card ${aspect === a.v ? 'active' : ''}`}>
                            <div className="aspect-box" style={{ width: a.w, height: a.h }}></div>
                            <span className="font-black text-[10px] uppercase">{a.l}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                    <div className="flex gap-3">
                      <button onClick={() => setEditingIndex(i => Math.max(0, i-1))} disabled={editingIndex === 0} className="flex-1 h-14 bg-white/5 rounded-2xl flex items-center justify-center text-slate-400 disabled:opacity-10"><ChevronRight size={24}/></button>
                      <button onClick={() => setEditingIndex(i => Math.min(images.length - 1, i+1))} disabled={editingIndex === images.length - 1} className="flex-1 h-14 bg-white/5 rounded-2xl flex items-center justify-center text-slate-400 disabled:opacity-10"><ChevronLeft size={24}/></button>
                    </div>
                  </div>
                  <div className="p-6 bg-slate-900 border-t border-white/5 space-y-4">
                    <button onClick={() => setCrop(getInitialCrop(imgRef.current, aspect))} className="w-full h-10 text-slate-500 font-black text-[10px] uppercase flex items-center justify-center gap-2 hover:text-white"><RefreshCw size={14}/> איפוס מסגרת</button>
                    <button onClick={handleConfirm} disabled={isProcessing} className="btn-main">
                      {isProcessing ? <Loader2 className="animate-spin" size={24}/> : (editingIndex === images.length - 1 ? 'סיום ושמירה' : 'אישור והמשך')}
                      <Check size={22}/>
                    </button>
                  </div>
                </aside>

                <section className="canvas-area">
                  <div style={{ transform: `scale(${zoom})`, transition: 'transform 0.2s', direction: 'ltr' }}>
                    <ReactCrop crop={crop} onChange={c => setCrop(c)} aspect={aspect} keepSelection unit="%">
                      <img ref={imgRef} src={images[editingIndex].url} onLoad={onImageLoad} className="max-w-full max-h-[65vh] shadow-2xl rounded-sm" draggable={false} />
                    </ReactCrop>
                  </div>
                  <div className="zoom-ctrl" dir="rtl">
                    <button onClick={() => setZoom(z => Math.max(0.5, z - 0.25))} className="text-slate-400 hover:text-white"><ZoomOut size={18}/></button>
                    <span className="text-white font-black text-[11px] w-10 text-center">{Math.round(zoom * 100)}%</span>
                    <button onClick={() => setZoom(z => Math.min(3, z + 0.25))} className="text-slate-400 hover:text-white"><ZoomIn size={18}/></button>
                    <div className="w-px h-4 bg-white/10"></div>
                    <button onClick={() => setZoom(1)} className="text-slate-400 hover:text-white"><Maximize size={16}/></button>
                  </div>
                </section>
              </div>
            </div>
          )}

          <footer className="py-12 bg-white text-center border-t border-slate-100 mt-auto">
             <p className="text-[10px] font-black text-slate-300 uppercase tracking-[0.4em]">Bulk Crop Engine {VERSION}</p>
          </footer>
        </div>
      );
    };

    createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>