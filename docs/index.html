<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Bulk Crop Pro | חיתוך קבוצתי חכם</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/react-image-crop/dist/ReactCrop.css" />
  <style>
    :root { --primary: #4f46e5; --primary-hover: #4338ca; }
    
    body { 
      font-family: 'Assistant', sans-serif; 
      background-color: #f8fafc; 
      color: #0f172a; 
      margin: 0; 
      min-height: 100vh;
      overflow-x: hidden;
      overflow-y: auto;
      user-select: none;
      -webkit-user-select: none;
      -webkit-overflow-scrolling: touch;
    }

    body.editor-active {
      overflow: hidden;
      height: 100vh;
    }
    
    .animate-in { animation: fadeIn 0.2s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .ReactCrop { 
      z-index: 100 !important; 
      direction: ltr !important;
    }
    .ReactCrop__crop-selection { 
      z-index: 110 !important;
      border: 1px solid white !important;
      outline: 1px solid var(--primary) !important;
      box-shadow: 0 0 0 9999em rgba(0, 0, 0, 0.7) !important;
    }
    .ReactCrop__drag-handle { 
      z-index: 120 !important;
      background-color: var(--primary) !important;
      width: 24px !important;
      height: 24px !important;
      border-radius: 50%;
      border: 2px solid white !important;
    }

    .editor-container {
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: #020617;
      display: flex;
      flex-direction: column;
      direction: ltr !important;
    }

    .editor-stage {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      padding: 10px;
    }

    .image-workspace {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      max-width: 100%;
      max-height: 100%;
    }

    .crop-target {
      display: block;
      max-width: 100%;
      max-height: 65vh;
      object-fit: contain;
    }

    .aspect-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #1e293b;
      background: #0f172a;
      color: #94a3b8;
      font-size: 10px;
      font-weight: 800;
      transition: all 0.2s;
    }
    .aspect-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .no-scrollbar::-webkit-scrollbar { display: none; }
  </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19",
    "react-dom": "https://esm.sh/react-dom@19",
    "react-dom/client": "https://esm.sh/react-dom@19/client",
    "lucide-react": "https://esm.sh/lucide-react@0.460.0",
    "react-image-crop": "https://esm.sh/react-image-crop@11.0.7"
  }
}
</script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-type="module" data-presets="react,typescript">
    import React, { useState, useEffect, useRef, useCallback } from 'react';
    import { createRoot } from 'react-dom/client';
    import { 
      Upload, Scissors, Download, X, Check, 
      Plus, ChevronLeft, ChevronRight, Copy, ImageIcon, RefreshCw, Minus, Loader2
    } from 'lucide-react';
    import ReactCrop, { centerCrop, makeAspectCrop } from 'react-image-crop';

    const VERSION = "v1.2.0";

    const App = () => {
      const [images, setImages] = useState([]);
      const [editingIndex, setEditingIndex] = useState(null);
      const [isProcessing, setIsProcessing] = useState(false);
      
      const [crop, setCrop] = useState();
      const [aspect, setAspect] = useState(undefined);
      const [zoom, setZoom] = useState(1);
      
      const imgRef = useRef(null);

      useEffect(() => {
        if (editingIndex !== null) document.body.classList.add('editor-active');
        else document.body.classList.remove('editor-active');
      }, [editingIndex]);

      const handleFiles = useCallback((files) => {
        const newFiles = Array.from(files).filter(f => f.type.startsWith('image/')).map(f => ({
          id: Math.random().toString(36).substr(2, 9),
          url: URL.createObjectURL(f),
          name: f.name,
          cropped: null,
          lastCrop: null,
          lastAspect: undefined
        }));
        setImages(prev => [...prev, ...newFiles]);
      }, []);

      const calculateInitialCrop = (img, targetAspect) => {
        if (!img) return;
        const nw = img.naturalWidth || img.width;
        const nh = img.naturalHeight || img.height;
        const effectiveAspect = targetAspect !== undefined ? targetAspect : (nw / nh);
        return centerCrop(makeAspectCrop({ unit: '%', width: 90 }, effectiveAspect, nw, nh), nw, nh);
      };

      const onImageLoad = (e) => {
        imgRef.current = e.currentTarget;
        const currentImg = images[editingIndex];
        if (currentImg?.lastCrop) {
          setCrop(currentImg.lastCrop);
          setAspect(currentImg.lastAspect);
        } else {
          setCrop(calculateInitialCrop(e.currentTarget, aspect));
        }
        setZoom(1);
      };

      const processImage = async (imgData, cropState) => {
        if (!cropState || !cropState.width) return null;
        return new Promise((resolve) => {
          const image = new Image();
          image.src = imgData.url;
          image.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const nw = image.naturalWidth;
            const nh = image.naturalHeight;
            const x = (cropState.x * nw) / 100;
            const y = (cropState.y * nh) / 100;
            const w = (cropState.width * nw) / 100;
            const h = (cropState.height * nh) / 100;
            canvas.width = w;
            canvas.height = h;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(image, x, y, w, h, 0, 0, w, h);
            canvas.toBlob(b => b ? resolve(URL.createObjectURL(b)) : resolve(null), 'image/jpeg', 0.92);
          };
          image.onerror = () => resolve(null);
        });
      };

      const handleSaveCurrent = async () => {
        setIsProcessing(true);
        const croppedUrl = await processImage(images[editingIndex], crop);
        if (croppedUrl) {
          setImages(prev => prev.map((img, i) => 
            i === editingIndex ? { ...img, cropped: croppedUrl, lastCrop: crop, lastAspect: aspect } : img
          ));
          if (editingIndex < images.length - 1) setEditingIndex(editingIndex + 1);
          else setEditingIndex(null);
        }
        setIsProcessing(false);
      };

      const downloadAll = async () => {
        for (let i = 0; i < images.length; i++) {
          const img = images[i];
          const finalUrl = img.cropped || await processImage(img, img.lastCrop);
          if (!finalUrl) continue;
          const link = document.createElement('a');
          link.href = finalUrl;
          link.download = `crop-${i+1}-${img.name}`;
          link.click();
          await new Promise(r => setTimeout(r, 400));
        }
      };

      return (
        <div className="flex flex-col min-h-screen" dir="rtl">
          <header className="h-16 bg-white border-b px-6 flex items-center justify-between z-40 sticky top-0 shadow-sm">
            <div className="flex items-center gap-3">
              <div className="bg-indigo-600 p-2 rounded-xl text-white shadow-lg"><Scissors size={20}/></div>
              <h1 className="text-xl font-black text-slate-900">Bulk Crop Pro</h1>
              <span className="text-[10px] font-bold text-slate-400">v{VERSION}</span>
            </div>
            {images.length > 0 && (
              <button onClick={() => setEditingIndex(0)} className="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-black shadow-xl">
                עריכה קבוצתית
              </button>
            )}
          </header>

          <main className="flex-1 p-4 md:p-12">
            {images.length === 0 ? (
              <div 
                onClick={() => { const i = document.createElement('input'); i.type='file'; i.multiple=true; i.accept="image/*"; i.onchange=e=>handleFiles(e.target.files); i.click(); }}
                className="min-h-[60vh] border-4 border-dashed border-slate-200 bg-white rounded-[2rem] flex flex-col items-center justify-center cursor-pointer"
              >
                <Upload size={48} className="text-slate-300 mb-6"/>
                <h2 className="text-xl font-black text-slate-800">בחר או גרור תמונות</h2>
              </div>
            ) : (
              <div className="max-w-7xl mx-auto space-y-6">
                <div className="flex justify-between items-center bg-white p-6 rounded-[1.5rem] border border-slate-100 shadow-sm">
                   <h2 className="text-xl font-black">הגלריה שלך ({images.length})</h2>
                   <button onClick={downloadAll} className="px-8 py-3 bg-slate-900 text-white rounded-xl font-black">הורד הכל</button>
                </div>
                <div className="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4">
                  {images.map((img, idx) => (
                    <div key={img.id} className="bg-white p-2 rounded-[1.2rem] border border-slate-100 shadow-md">
                      <div className="aspect-square relative rounded-[0.8rem] overflow-hidden">
                        <img src={img.cropped || img.url} className="w-full h-full object-cover" />
                      </div>
                      <button onClick={() => setEditingIndex(idx)} className="mt-2 text-indigo-600 w-full flex justify-center py-1"><ImageIcon size={18}/></button>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </main>

          {editingIndex !== null && (
            <div className="editor-container" dir="ltr">
              <header className="h-14 px-4 bg-slate-900 border-b border-white/5 flex justify-between items-center">
                <span className="text-white text-[11px] font-black">{editingIndex + 1} / {images.length}</span>
                <button onClick={() => setEditingIndex(null)} className="text-slate-400"><X size={24}/></button>
              </header>
              <div className="flex-1 flex flex-col md:flex-row overflow-hidden relative">
                 <aside className="bg-slate-900 p-4 shrink-0 flex gap-2 md:flex-col overflow-x-auto no-scrollbar">
                    {[
                      {l: '1:1', v: 1, w: 18, h: 18}, 
                      {l: '16:9', v: 16/9, w: 24, h: 14}, 
                      {l: '9:16', v: 9/16, w: 14, h: 24}
                    ].map(a => (
                      <button key={a.l} onClick={() => changeAspect(a.v)} className={`aspect-btn shrink-0 ${aspect === a.v ? 'active' : ''}`}>
                         {a.l}
                      </button>
                    ))}
                 </aside>
                 <section className="editor-stage bg-black relative">
                   {isProcessing && <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/50"><Loader2 className="animate-spin text-white" size={32}/></div>}
                   <div className="image-workspace" style={{ transform: `scale(${zoom})` }}>
                     <ReactCrop crop={crop} onChange={c => setCrop(c)} aspect={aspect} unit="%">
                       <img ref={imgRef} src={images[editingIndex].url} onLoad={onImageLoad} className="crop-target select-none" draggable={false}/>
                     </ReactCrop>
                   </div>
                 </section>
              </div>
              <footer className="bg-slate-900 p-4 flex gap-4" dir="rtl">
                <button onClick={() => setEditingIndex(null)} className="flex-1 h-12 bg-white/5 text-white rounded-xl font-black">ביטול</button>
                <button onClick={handleSaveCurrent} className="flex-1 h-12 bg-indigo-600 text-white rounded-xl font-black">אישור והמשך</button>
              </footer>
            </div>
          )}
        </div>
      );
    };

    createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>